<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scout Financial Tracker</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #2d5016 0%, #4a7c26 100%);
            color: #333;
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }
        
        h1 {
            font-size: 2.5em;
            margin-bottom: 5px;
        }
        
        .subtitle {
            font-size: 1.1em;
            opacity: 0.9;
        }
        
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            text-align: center;
        }
        
        .stat-label {
            color: #666;
            font-size: 0.9em;
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2d5016;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 1fr 400px;
            gap: 20px;
            margin-bottom: 30px;
        }
        
        @media (max-width: 968px) {
            .main-content {
                grid-template-columns: 1fr;
            }
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #4a7c26;
        }
        
        .card-title {
            font-size: 1.5em;
            color: #2d5016;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.3s;
        }
        
        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #4a7c26;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .button {
            background: #4a7c26;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
            width: 100%;
        }
        
        .button:hover {
            background: #3a6620;
        }
        
        .button-secondary {
            background: #6c757d;
        }
        
        .button-secondary:hover {
            background: #5a6268;
        }
        
        .button-danger {
            background: #dc3545;
        }
        
        .button-danger:hover {
            background: #c82333;
        }
        
        .expense-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .expense-item {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            transition: transform 0.2s;
        }
        
        .expense-item:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }
        
        .expense-info {
            flex: 1;
        }
        
        .expense-description {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }
        
        .expense-meta {
            font-size: 0.9em;
            color: #666;
        }
        
        .expense-category {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
            margin-right: 8px;
        }
        
        .expense-amount {
            font-size: 1.3em;
            font-weight: bold;
            color: #dc3545;
            white-space: nowrap;
            margin-left: 15px;
        }
        
        .expense-delete {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85em;
            margin-left: 10px;
        }
        
        .expense-delete:hover {
            background: #c82333;
        }
        
        .category-camping { background: #d4edda; color: #155724; }
        .category-equipment { background: #cce5ff; color: #004085; }
        .category-uniforms { background: #fff3cd; color: #856404; }
        .category-trips { background: #f8d7da; color: #721c24; }
        .category-food { background: #d1ecf1; color: #0c5460; }
        .category-activities { background: #e2e3e5; color: #383d41; }
        .category-registration { background: #d6d8db; color: #1b1e21; }
        .category-grub { background: #ffc107; color: #856404; font-weight: 700; }
        .category-other { background: #f5c6cb; color: #721c24; }
        
        .budget-section {
            margin-top: 25px;
        }
        
        .budget-item {
            margin-bottom: 20px;
        }
        
        .budget-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 0.9em;
        }
        
        .budget-bar {
            width: 100%;
            height: 24px;
            background: #e9ecef;
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }
        
        .budget-fill {
            height: 100%;
            background: #4a7c26;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
            color: white;
            font-weight: 600;
        }
        
        .budget-fill.warning {
            background: #ffc107;
        }
        
        .budget-fill.danger {
            background: #dc3545;
        }
        
        .filter-section {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .filter-button {
            padding: 8px 16px;
            border: 2px solid #4a7c26;
            background: white;
            color: #4a7c26;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .filter-button:hover {
            background: #f0f8f0;
        }
        
        .filter-button.active {
            background: #4a7c26;
            color: white;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 15px;
        }
        
        .export-section {
            margin-top: 20px;
            padding-top: 20px;
            border-top: 2px solid #e9ecef;
        }
        
        .button-group {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-modal {
            font-size: 1.5em;
            cursor: pointer;
            color: #666;
        }
        
        .balance-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .balance-card.positive {
            border-left: 4px solid #28a745;
        }
        
        .balance-card.negative {
            border-left: 4px solid #dc3545;
        }
        
        .balance-info {
            flex: 1;
        }
        
        .balance-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 4px;
        }
        
        .balance-patrol {
            font-size: 0.85em;
            color: #666;
        }
        
        .balance-amount {
            font-size: 1.5em;
            font-weight: bold;
        }
        
        .balance-amount.positive {
            color: #28a745;
        }
        
        .balance-amount.negative {
            color: #dc3545;
        }
        
        .balance-amount.zero {
            color: #6c757d;
        }
        
        .scout-checkbox-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 5px;
            background: #f8f9fa;
            border-radius: 6px;
            cursor: pointer;
            transition: background 0.2s;
        }
        
        .scout-checkbox-item:hover {
            background: #e9ecef;
        }
        
        .scout-checkbox-item input[type="checkbox"] {
            width: auto;
            margin-right: 10px;
            cursor: pointer;
        }
        
        .scout-checkbox-item label {
            margin: 0;
            cursor: pointer;
            flex: 1;
            font-weight: 500;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üèïÔ∏è Scout Financial Tracker</h1>
            <p class="subtitle">Manage Your Troop's Expenses</p>
        </header>
        
        <div class="dashboard">
            <div class="stat-card">
                <div class="stat-label">Total Spent</div>
                <div class="stat-value" id="totalSpent">$0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Credits</div>
                <div class="stat-value" id="totalCredits">$0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Troop Balance</div>
                <div class="stat-value" id="troopBalance">$0.00</div>
            </div>
            <div class="stat-card">
                <div class="stat-label">Total Expenses</div>
                <div class="stat-value" id="totalCount">0</div>
            </div>
        </div>
        
        <div class="main-content">
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Add New Expense</h2>
                </div>
                
                <form id="expenseForm">
                    <div class="form-group">
                        <label for="description">Description *</label>
                        <input type="text" id="description" placeholder="e.g., Camping gear for spring trip" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="amount">Amount ($) *</label>
                        <input type="number" id="amount" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="category">Category *</label>
                        <select id="category" required onchange="handleCategoryChange()">
                            <option value="">Select a category</option>
                            <option value="grub">Grub Expense (Shared Food)</option>
                            <option value="camping">Camping Equipment</option>
                            <option value="equipment">General Equipment</option>
                            <option value="uniforms">Uniforms & Patches</option>
                            <option value="trips">Trips & Outings</option>
                            <option value="food">Food & Supplies</option>
                            <option value="activities">Activities & Programs</option>
                            <option value="registration">Registration & Fees</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                    
                    <div id="grubExpenseFields" style="display: none;">
                        <div class="form-group">
                            <label for="grubSubmitter">Who Paid/Submitted? *</label>
                            <select id="grubSubmitter">
                                <option value="">Select scout who paid</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label>Select All Scouts Involved (including submitter) *</label>
                            <div id="grubScoutsCheckboxes" style="max-height: 200px; overflow-y: auto; border: 2px solid #ddd; border-radius: 8px; padding: 10px;">
                                <p style="color: #666; text-align: center;">No scouts available</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group" id="patrolSelectGroup" style="display: none;">
                        <label for="patrolSelect">Select Patrol *</label>
                        <select id="patrolSelect">
                            <option value="">Select patrol</option>
                        </select>
                        <button type="button" class="button button-secondary" style="margin-top: 10px;" onclick="openPatrolManager()">Manage Patrols</button>
                    </div>
                    
                    <div class="form-group" id="scoutSelectGroup" style="display: none;">
                        <label for="scoutSelect">Select Scout *</label>
                        <select id="scoutSelect">
                            <option value="">Select scout</option>
                        </select>
                        <button type="button" class="button button-secondary" style="margin-top: 10px;" onclick="openScoutManager()">Manage Scouts</button>
                    </div>
                    
                    <div class="form-group">
                        <label for="expenseType">Expense For *</label>
                        <select id="expenseType" required onchange="handleExpenseTypeChange()">
                            <option value="">Select type</option>
                            <option value="troop">Entire Troop</option>
                            <option value="patrol">Patrol</option>
                            <option value="scout">Individual Scout</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="date">Date *</label>
                        <input type="date" id="date" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="notes">Notes (Optional)</label>
                        <textarea id="notes" placeholder="Additional details..."></textarea>
                    </div>
                    
                    <button type="submit" class="button">Add Expense</button>
                </form>
            </div>
            
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Budget Tracker</h2>
                    <button class="button-secondary" style="padding: 8px 16px; width: auto;" onclick="openBudgetModal()">Set Budgets</button>
                </div>
                
                <div class="budget-section" id="budgetSection">
                    <p style="color: #666; text-align: center;">Set category budgets to track spending</p>
                </div>
                
                <div class="export-section">
                    <h3 style="margin-bottom: 15px;">Export Data</h3>
                    <div class="button-group">
                        <button class="button button-secondary" onclick="exportToCSV()">Download CSV</button>
                        <button class="button button-secondary" onclick="printReport()">Print Report</button>
                    </div>
                </div>
            </div>
            
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h2 class="card-title">Credits Management</h2>
                </div>
                
                <form id="creditForm">
                    <div class="form-group">
                        <label for="creditType">Credit Type *</label>
                        <select id="creditType" required onchange="handleCreditTypeChange()">
                            <option value="">Select type</option>
                            <option value="scout">Scout Payment</option>
                            <option value="patrol">Patrol Payment</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="creditScoutGroup" style="display: none;">
                        <label for="creditScoutSelect">Select Scout *</label>
                        <select id="creditScoutSelect">
                            <option value="">Select scout</option>
                        </select>
                    </div>
                    
                    <div class="form-group" id="creditPatrolGroup" style="display: none;">
                        <label for="creditPatrolSelect">Select Patrol *</label>
                        <select id="creditPatrolSelect">
                            <option value="">Select patrol</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="creditAmount">Amount ($) *</label>
                        <input type="number" id="creditAmount" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="creditDate">Date *</label>
                        <input type="date" id="creditDate" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="creditNotes">Notes (Optional)</label>
                        <textarea id="creditNotes" placeholder="Payment details..."></textarea>
                    </div>
                    
                    <button type="submit" class="button">Add Credit</button>
                </form>
            </div>
        </div>
        
        <div class="card" style="margin-bottom: 30px;">
            <div class="card-header">
                <h2 class="card-title">Credit History</h2>
            </div>
            <div class="expense-list" id="creditList">
                <div class="empty-state">
                    <div class="empty-state-icon">üí≥</div>
                    <p>No credits recorded yet.</p>
                </div>
            </div>
        </div>
        
        <div class="card" style="margin-bottom: 30px;">
            <div class="card-header">
                <h2 class="card-title">Scout Balances</h2>
                <select id="scoutBalanceFilter" onchange="updateScoutBalanceView()" style="padding: 8px 16px; border: 2px solid #4a7c26; border-radius: 8px; font-weight: 600;">
                    <option value="all">All Scouts</option>
                </select>
            </div>
            <div id="scoutBalanceDisplay">
                <div class="empty-state">
                    <div class="empty-state-icon">üí∞</div>
                    <p>No scouts added yet. Add scouts to track their balances.</p>
                </div>
            </div>
        </div>
        
        <div class="card">
            <div class="card-header">
                <h2 class="card-title">Expense History</h2>
            </div>
            
            <div class="filter-section">
                <div style="width: 100%; margin-bottom: 15px;">
                    <strong>Filter by Category:</strong>
                </div>
                <button class="filter-button active" onclick="filterByCategory('all')">All</button>
                <button class="filter-button" onclick="filterByCategory('camping')">Camping</button>
                <button class="filter-button" onclick="filterByCategory('equipment')">Equipment</button>
                <button class="filter-button" onclick="filterByCategory('uniforms')">Uniforms</button>
                <button class="filter-button" onclick="filterByCategory('trips')">Trips</button>
                <button class="filter-button" onclick="filterByCategory('food')">Food</button>
                <button class="filter-button" onclick="filterByCategory('activities')">Activities</button>
            </div>
            
            <div class="filter-section">
                <div style="width: 100%; margin-bottom: 15px;">
                    <strong>Filter by Type:</strong>
                </div>
                <button class="filter-button active" onclick="filterByType('all')">All</button>
                <button class="filter-button" onclick="filterByType('troop')">Troop</button>
                <button class="filter-button" onclick="filterByType('patrol')">Patrol</button>
                <button class="filter-button" onclick="filterByType('scout')">Scout</button>
            </div>
            
            <div class="filter-section" id="entityFilterSection" style="display: none;">
                <div style="width: 100%; margin-bottom: 15px;">
                    <strong id="entityFilterLabel">Filter by:</strong>
                </div>
                <div id="entityFilters"></div>
            </div>
            
            <div class="expense-list" id="expenseList">
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <p>No expenses yet. Add your first expense above!</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Budget Modal -->
    <div class="modal" id="budgetModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Set Category Budgets</h2>
                <span class="close-modal" onclick="closeBudgetModal()">&times;</span>
            </div>
            <form id="budgetForm">
                <div class="form-group">
                    <label>Camping Equipment</label>
                    <input type="number" id="budget-camping" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>General Equipment</label>
                    <input type="number" id="budget-equipment" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Uniforms & Patches</label>
                    <input type="number" id="budget-uniforms" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Trips & Outings</label>
                    <input type="number" id="budget-trips" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Food & Supplies</label>
                    <input type="number" id="budget-food" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Activities & Programs</label>
                    <input type="number" id="budget-activities" step="0.01" min="0" placeholder="0.00">
                </div>
                <div class="form-group">
                    <label>Registration & Fees</label>
                    <input type="number" id="budget-registration" step="0.01" min="0" placeholder="0.00">
                </div>
                <button type="submit" class="button">Save Budgets</button>
            </form>
        </div>
    </div>
    
    <!-- Patrol Manager Modal -->
    <div class="modal" id="patrolModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Patrols</h2>
                <span class="close-modal" onclick="closePatrolManager()">&times;</span>
            </div>
            <div class="form-group">
                <label>Add New Patrol</label>
                <input type="text" id="newPatrolName" placeholder="Enter patrol name">
                <button type="button" class="button" style="margin-top: 10px;" onclick="addPatrol()">Add Patrol</button>
            </div>
            <div style="margin-top: 20px;">
                <h3 style="margin-bottom: 10px;">Current Patrols:</h3>
                <div id="patrolList"></div>
            </div>
        </div>
    </div>
    
    <!-- Scout Manager Modal -->
    <div class="modal" id="scoutModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Manage Scouts</h2>
                <span class="close-modal" onclick="closeScoutManager()">&times;</span>
            </div>
            <div class="form-group">
                <label>Add New Scout</label>
                <input type="text" id="newScoutName" placeholder="Enter scout name">
                <label style="margin-top: 10px;">Assign to Patrol</label>
                <select id="scoutPatrolSelect">
                    <option value="">No patrol (unassigned)</option>
                </select>
                <button type="button" class="button" style="margin-top: 10px;" onclick="addScout()">Add Scout</button>
            </div>
            <div style="margin-top: 20px;">
                <h3 style="margin-bottom: 10px;">Current Scouts:</h3>
                <div id="scoutList"></div>
            </div>
        </div>
    </div>
    
    <!-- Scout Report Modal -->
    <div class="modal" id="scoutReportModal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 id="scoutReportTitle">Scout Transaction Report</h2>
                <span class="close-modal" onclick="closeScoutReport()">&times;</span>
            </div>
            
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px;">
                <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; text-align: center;">
                    <div>
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Total Credits</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #28a745;" id="reportTotalCredits">$0.00</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Total Debits</div>
                        <div style="font-size: 1.5em; font-weight: bold; color: #dc3545;" id="reportTotalDebits">$0.00</div>
                    </div>
                    <div>
                        <div style="font-size: 0.9em; color: #666; margin-bottom: 5px;">Current Balance</div>
                        <div style="font-size: 1.5em; font-weight: bold;" id="reportBalance">$0.00</div>
                    </div>
                </div>
            </div>
            
            <div style="margin-bottom: 15px;">
                <div class="button-group">
                    <button class="button button-secondary" onclick="exportScoutReportPDF()">Export to PDF</button>
                    <button class="button button-secondary" onclick="exportScoutReportExcel()">Export to Excel</button>
                </div>
            </div>
            
            <h3 style="margin-bottom: 15px;">Transaction History</h3>
            <div id="scoutTransactionList" style="max-height: 400px; overflow-y: auto;">
                <div class="empty-state">
                    <div class="empty-state-icon">üìã</div>
                    <p>No transactions found</p>
                </div>
            </div>
        </div>
    </div>
    
    <script>
        let expenses = [];
        let credits = [];
        let budgets = {};
        let patrols = [];
        let scouts = [];
        let scoutCredits = {}; // Track credits: positive = scout paid, negative = scout owes
        let troopBalance = 0;
        let currentCategoryFilter = 'all';
        let currentTypeFilter = 'all';
        let currentEntityFilter = 'all';
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            loadData();
            setTodayDate();
            setCreditDate();
            updateDropdowns();
            updateScoutBalanceDropdown();
            renderExpenses();
            renderCredits();
            updateStats();
            updateBudgetDisplay();
            updateScoutBalanceView();
        });
        
        // Set today's date as default
        function setTodayDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
        }
        
        // Set today's date for credit form
        function setCreditDate() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('creditDate').value = today;
        }
        
        // Load data from localStorage
        function loadData() {
            const savedExpenses = localStorage.getItem('scoutExpenses');
            const savedCredits = localStorage.getItem('scoutCreditsHistory');
            const savedBudgets = localStorage.getItem('scoutBudgets');
            const savedPatrols = localStorage.getItem('scoutPatrols');
            const savedScouts = localStorage.getItem('scoutScouts');
            const savedScoutCredits = localStorage.getItem('scoutCredits');
            const savedTroopBalance = localStorage.getItem('troopBalance');
            
            if (savedExpenses) {
                expenses = JSON.parse(savedExpenses);
            }
            
            if (savedCredits) {
                credits = JSON.parse(savedCredits);
            }
            
            if (savedBudgets) {
                budgets = JSON.parse(savedBudgets);
            }
            
            if (savedPatrols) {
                patrols = JSON.parse(savedPatrols);
            }
            
            if (savedScouts) {
                scouts = JSON.parse(savedScouts);
            }
            
            if (savedScoutCredits) {
                scoutCredits = JSON.parse(savedScoutCredits);
            }
            
            if (savedTroopBalance) {
                troopBalance = parseFloat(savedTroopBalance);
            }
            
            // Initialize credits for all scouts if not exists
            scouts.forEach(scout => {
                if (!(scout.id in scoutCredits)) {
                    scoutCredits[scout.id] = 0;
                }
            });
        }
        
        // Save data to localStorage
        function saveData() {
            localStorage.setItem('scoutExpenses', JSON.stringify(expenses));
            localStorage.setItem('scoutCreditsHistory', JSON.stringify(credits));
            localStorage.setItem('scoutBudgets', JSON.stringify(budgets));
            localStorage.setItem('scoutPatrols', JSON.stringify(patrols));
            localStorage.setItem('scoutScouts', JSON.stringify(scouts));
            localStorage.setItem('scoutCredits', JSON.stringify(scoutCredits));
            localStorage.setItem('troopBalance', troopBalance.toString());
        }
        
        // Handle category change
        function handleCategoryChange() {
            const category = document.getElementById('category').value;
            const grubFields = document.getElementById('grubExpenseFields');
            const expenseTypeGroup = document.getElementById('expenseType').parentElement;
            const patrolSelectGroup = document.getElementById('patrolSelectGroup');
            const scoutSelectGroup = document.getElementById('scoutSelectGroup');
            
            if (category === 'grub') {
                // Show grub fields, hide regular expense type fields
                grubFields.style.display = 'block';
                expenseTypeGroup.style.display = 'none';
                patrolSelectGroup.style.display = 'none';
                scoutSelectGroup.style.display = 'none';
                
                // Remove required from regular fields
                document.getElementById('expenseType').required = false;
                document.getElementById('patrolSelect').required = false;
                document.getElementById('scoutSelect').required = false;
                
                // Populate grub submitter and checkboxes
                updateGrubScoutFields();
            } else {
                // Show regular expense fields, hide grub fields
                grubFields.style.display = 'none';
                expenseTypeGroup.style.display = 'block';
                
                // Add required back to expense type
                document.getElementById('expenseType').required = true;
                
                // Reset expense type selection to trigger proper field display
                const currentExpenseType = document.getElementById('expenseType').value;
                if (currentExpenseType) {
                    handleExpenseTypeChange();
                }
            }
        }
        
        // Update grub scout fields
        function updateGrubScoutFields() {
            const grubSubmitter = document.getElementById('grubSubmitter');
            const grubCheckboxes = document.getElementById('grubScoutsCheckboxes');
            
            // Update submitter dropdown
            let submitterOptions = '<option value="">Select scout who paid</option>';
            patrols.forEach(patrol => {
                const patrolScouts = scouts.filter(s => s.patrolId === patrol.id);
                if (patrolScouts.length > 0) {
                    submitterOptions += `<optgroup label="${patrol.name}">`;
                    patrolScouts.forEach(s => {
                        submitterOptions += `<option value="${s.id}">${s.name}</option>`;
                    });
                    submitterOptions += `</optgroup>`;
                }
            });
            
            const unassignedScouts = scouts.filter(s => !s.patrolId);
            if (unassignedScouts.length > 0) {
                submitterOptions += `<optgroup label="Unassigned">`;
                unassignedScouts.forEach(s => {
                    submitterOptions += `<option value="${s.id}">${s.name}</option>`;
                });
                submitterOptions += `</optgroup>`;
            }
            
            grubSubmitter.innerHTML = submitterOptions;
            
            // Update checkboxes
            if (scouts.length === 0) {
                grubCheckboxes.innerHTML = '<p style="color: #666; text-align: center; padding: 10px;">No scouts available</p>';
                return;
            }
            
            let checkboxesHTML = '';
            
            patrols.forEach(patrol => {
                const patrolScouts = scouts.filter(s => s.patrolId === patrol.id);
                if (patrolScouts.length > 0) {
                    checkboxesHTML += `<div style="font-weight: 600; margin: 10px 0 5px 0; color: #4a7c26;">${patrol.name}</div>`;
                    patrolScouts.forEach(s => {
                        checkboxesHTML += `
                            <div class="scout-checkbox-item">
                                <input type="checkbox" id="grub-scout-${s.id}" value="${s.id}">
                                <label for="grub-scout-${s.id}">${s.name}</label>
                            </div>
                        `;
                    });
                }
            });
            
            const unassigned = scouts.filter(s => !s.patrolId);
            if (unassigned.length > 0) {
                checkboxesHTML += `<div style="font-weight: 600; margin: 10px 0 5px 0; color: #666;">Unassigned</div>`;
                unassigned.forEach(s => {
                    checkboxesHTML += `
                        <div class="scout-checkbox-item">
                            <input type="checkbox" id="grub-scout-${s.id}" value="${s.id}">
                            <label for="grub-scout-${s.id}">${s.name}</label>
                        </div>
                    `;
                });
            }
            
            grubCheckboxes.innerHTML = checkboxesHTML;
        }
        
        // Handle expense type change
        function handleExpenseTypeChange() {
            const expenseType = document.getElementById('expenseType').value;
            const patrolGroup = document.getElementById('patrolSelectGroup');
            const scoutGroup = document.getElementById('scoutSelectGroup');
            
            patrolGroup.style.display = 'none';
            scoutGroup.style.display = 'none';
            
            if (expenseType === 'patrol') {
                patrolGroup.style.display = 'block';
                document.getElementById('patrolSelect').required = true;
                document.getElementById('scoutSelect').required = false;
            } else if (expenseType === 'scout') {
                scoutGroup.style.display = 'block';
                document.getElementById('scoutSelect').required = true;
                document.getElementById('patrolSelect').required = false;
            } else {
                document.getElementById('patrolSelect').required = false;
                document.getElementById('scoutSelect').required = false;
            }
        }
        
        // Handle paid by change
        function handlePaidByChange() {
            const paidBy = document.getElementById('paidBy').value;
            const paidByScoutGroup = document.getElementById('paidByScoutGroup');
            
            if (paidBy === 'scout') {
                paidByScoutGroup.style.display = 'block';
                document.getElementById('paidByScoutSelect').required = true;
            } else {
                paidByScoutGroup.style.display = 'none';
                document.getElementById('paidByScoutSelect').required = false;
            }
        }
        
        // Handle credit type change
        function handleCreditTypeChange() {
            const creditType = document.getElementById('creditType').value;
            const creditScoutGroup = document.getElementById('creditScoutGroup');
            const creditPatrolGroup = document.getElementById('creditPatrolGroup');
            
            creditScoutGroup.style.display = 'none';
            creditPatrolGroup.style.display = 'none';
            
            if (creditType === 'scout') {
                creditScoutGroup.style.display = 'block';
                document.getElementById('creditScoutSelect').required = true;
                document.getElementById('creditPatrolSelect').required = false;
            } else if (creditType === 'patrol') {
                creditPatrolGroup.style.display = 'block';
                document.getElementById('creditPatrolSelect').required = true;
                document.getElementById('creditScoutSelect').required = false;
            } else {
                document.getElementById('creditScoutSelect').required = false;
                document.getElementById('creditPatrolSelect').required = false;
            }
        }
        
        // Update dropdowns
        function updateDropdowns() {
            const patrolSelect = document.getElementById('patrolSelect');
            const scoutSelect = document.getElementById('scoutSelect');
            const scoutPatrolSelect = document.getElementById('scoutPatrolSelect');
            const creditScoutSelect = document.getElementById('creditScoutSelect');
            const creditPatrolSelect = document.getElementById('creditPatrolSelect');
            
            patrolSelect.innerHTML = '<option value="">Select patrol</option>' +
                patrols.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            
            creditPatrolSelect.innerHTML = '<option value="">Select patrol</option>' +
                patrols.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
            
            // Group scouts by patrol for the expense form
            let scoutOptions = '<option value="">Select scout</option>';
            
            // Scouts assigned to patrols
            patrols.forEach(patrol => {
                const patrolScouts = scouts.filter(s => s.patrolId === patrol.id);
                if (patrolScouts.length > 0) {
                    scoutOptions += `<optgroup label="${patrol.name}">`;
                    patrolScouts.forEach(s => {
                        scoutOptions += `<option value="${s.id}">${s.name}</option>`;
                    });
                    scoutOptions += `</optgroup>`;
                }
            });
            
            // Unassigned scouts
            const unassignedScouts = scouts.filter(s => !s.patrolId);
            if (unassignedScouts.length > 0) {
                scoutOptions += `<optgroup label="Unassigned">`;
                unassignedScouts.forEach(s => {
                    scoutOptions += `<option value="${s.id}">${s.name}</option>`;
                });
                scoutOptions += `</optgroup>`;
            }
            
            scoutSelect.innerHTML = scoutOptions;
            creditScoutSelect.innerHTML = scoutOptions;
            
            // Update patrol select in scout manager modal
            scoutPatrolSelect.innerHTML = '<option value="">No patrol (unassigned)</option>' +
                patrols.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
        }
        
        // Update scout balance dropdown
        function updateScoutBalanceDropdown() {
            const select = document.getElementById('scoutBalanceFilter');
            
            let options = '<option value="all">All Scouts</option>';
            
            // Group by patrol
            patrols.forEach(patrol => {
                const patrolScouts = scouts.filter(s => s.patrolId === patrol.id);
                if (patrolScouts.length > 0) {
                    options += `<optgroup label="${patrol.name}">`;
                    patrolScouts.forEach(s => {
                        options += `<option value="${s.id}">${s.name}</option>`;
                    });
                    options += `</optgroup>`;
                }
            });
            
            const unassignedScouts = scouts.filter(s => !s.patrolId);
            if (unassignedScouts.length > 0) {
                options += `<optgroup label="Unassigned">`;
                unassignedScouts.forEach(s => {
                    options += `<option value="${s.id}">${s.name}</option>`;
                });
                options += `</optgroup>`;
            }
            
            select.innerHTML = options;
        }
        
        // Add expense
        document.getElementById('expenseForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const category = document.getElementById('category').value;
            const amount = parseFloat(document.getElementById('amount').value);
            
            // Handle Grub Expense differently
            if (category === 'grub') {
                const submitterId = document.getElementById('grubSubmitter').value;
                if (!submitterId) {
                    alert('Please select who paid for this expense');
                    return;
                }
                
                // Get all checked scouts
                const checkedScouts = [];
                scouts.forEach(scout => {
                    const checkbox = document.getElementById(`grub-scout-${scout.id}`);
                    if (checkbox && checkbox.checked) {
                        checkedScouts.push(scout.id);
                    }
                });
                
                if (checkedScouts.length === 0) {
                    alert('Please select at least one scout involved in this expense');
                    return;
                }
                
                const submitterName = scouts.find(s => s.id === submitterId)?.name || '';
                
                const expense = {
                    id: Date.now(),
                    description: document.getElementById('description').value,
                    amount: amount,
                    category: 'grub',
                    date: document.getElementById('date').value,
                    notes: document.getElementById('notes').value,
                    expenseType: 'grub',
                    submitterId: submitterId,
                    submitterName: submitterName,
                    involvedScouts: checkedScouts
                };
                
                // Process grub expense
                processGrubExpense(expense);
                
                expenses.push(expense);
                
            } else {
                // Regular expense
                const expenseType = document.getElementById('expenseType').value;
                
                const expense = {
                    id: Date.now(),
                    description: document.getElementById('description').value,
                    amount: amount,
                    category: category,
                    date: document.getElementById('date').value,
                    notes: document.getElementById('notes').value,
                    expenseType: expenseType,
                    entityId: null,
                    entityName: null
                };
                
                if (expenseType === 'patrol') {
                    expense.entityId = document.getElementById('patrolSelect').value;
                    expense.entityName = patrols.find(p => p.id === expense.entityId)?.name || '';
                } else if (expenseType === 'scout') {
                    expense.entityId = document.getElementById('scoutSelect').value;
                    expense.entityName = scouts.find(s => s.id === expense.entityId)?.name || '';
                }
                
                // Deduct from scouts based on expense type
                distributeExpense(expense);
                
                expenses.push(expense);
            }
            
            saveData();
            
            // Reset form
            e.target.reset();
            setTodayDate();
            handleExpenseTypeChange();
            handleCategoryChange();
            
            // Update display
            renderExpenses();
            renderCredits(); // Update credits since grub expenses show there too
            updateStats();
            updateBudgetDisplay();
            updateScoutBalanceView();
        });
        
        // Process grub expense
        function processGrubExpense(expense) {
            const amount = expense.amount;
            const submitterId = expense.submitterId;
            const involvedScouts = expense.involvedScouts;
            
            if (involvedScouts.length === 0) return;
            
            const perScoutShare = amount / involvedScouts.length;
            
            // First, credit the full amount to the submitter (who paid out of pocket)
            if (!(submitterId in scoutCredits)) scoutCredits[submitterId] = 0;
            scoutCredits[submitterId] += amount;
            
            // Then, deduct the share from each involved scout (including the submitter)
            involvedScouts.forEach(scoutId => {
                if (!(scoutId in scoutCredits)) scoutCredits[scoutId] = 0;
                scoutCredits[scoutId] -= perScoutShare;
            });
            
            // Example: Surya pays $50 for 4 scouts
            // Step 1: Surya gets +$50 (he paid)
            // Step 2: All 4 scouts get -$12.50 each (including Surya)
            // Result: Surya = +$50 - $12.50 = +$37.50 (he's owed)
            //         Others = -$12.50 each (they owe)
            
            // Troop balance decreases by the expense
            troopBalance -= amount;
        }
        
        // Distribute expense to scouts (decreases their balance)
        function distributeExpense(expense) {
            const amount = expense.amount;
            let affectedScouts = [];
            
            // Determine which scouts are affected by this expense
            if (expense.expenseType === 'troop') {
                // All scouts
                affectedScouts = scouts.map(s => s.id);
            } else if (expense.expenseType === 'patrol' && expense.entityId) {
                // All scouts in the patrol
                affectedScouts = scouts.filter(s => s.patrolId === expense.entityId).map(s => s.id);
            } else if (expense.expenseType === 'scout' && expense.entityId) {
                // Single scout
                affectedScouts = [expense.entityId];
            }
            
            if (affectedScouts.length === 0) return;
            
            const perScoutShare = amount / affectedScouts.length;
            
            // Decrease each affected scout's balance (they owe this amount)
            affectedScouts.forEach(scoutId => {
                if (!(scoutId in scoutCredits)) scoutCredits[scoutId] = 0;
                scoutCredits[scoutId] -= perScoutShare;
            });
            
            // Decrease troop balance
            troopBalance -= amount;
        }
        
        // Add credit
        document.getElementById('creditForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const creditType = document.getElementById('creditType').value;
            const amount = parseFloat(document.getElementById('creditAmount').value);
            
            const credit = {
                id: Date.now(),
                type: creditType,
                amount: amount,
                date: document.getElementById('creditDate').value,
                notes: document.getElementById('creditNotes').value,
                entityId: null,
                entityName: null,
                scouts: []
            };
            
            if (creditType === 'scout') {
                credit.entityId = document.getElementById('creditScoutSelect').value;
                const scout = scouts.find(s => s.id === credit.entityId);
                credit.entityName = scout ? scout.name : '';
                credit.scouts = [credit.entityId];
                
                // Add credit to scout's balance
                if (!(credit.entityId in scoutCredits)) scoutCredits[credit.entityId] = 0;
                scoutCredits[credit.entityId] += amount;
                
            } else if (creditType === 'patrol') {
                credit.entityId = document.getElementById('creditPatrolSelect').value;
                const patrol = patrols.find(p => p.id === credit.entityId);
                credit.entityName = patrol ? patrol.name : '';
                
                // Get all scouts in patrol
                const patrolScouts = scouts.filter(s => s.patrolId === credit.entityId);
                credit.scouts = patrolScouts.map(s => s.id);
                
                if (patrolScouts.length > 0) {
                    const perScoutAmount = amount / patrolScouts.length;
                    patrolScouts.forEach(scout => {
                        if (!(scout.id in scoutCredits)) scoutCredits[scout.id] = 0;
                        scoutCredits[scout.id] += perScoutAmount;
                    });
                }
            }
            
            // Increase troop balance
            troopBalance += amount;
            
            credits.push(credit);
            saveData();
            
            // Reset form
            e.target.reset();
            setCreditDate();
            handleCreditTypeChange();
            
            // Update display
            renderCredits();
            updateStats();
            updateScoutBalanceView();
        });
        
        // Delete expense
        function deleteExpense(id) {
            if (confirm('Are you sure you want to delete this expense?')) {
                expenses = expenses.filter(exp => exp.id !== id);
                recalculateAllBalances();
                saveData();
                renderExpenses();
                renderCredits(); // Update credits in case it was a grub expense
                updateStats();
                updateBudgetDisplay();
                updateScoutBalanceView();
            }
        }
        
        // Delete credit
        function deleteCredit(id) {
            if (confirm('Are you sure you want to delete this credit?')) {
                credits = credits.filter(cred => cred.id !== id);
                recalculateAllBalances();
                saveData();
                renderCredits();
                updateStats();
                updateScoutBalanceView();
            }
        }
        
        // Recalculate all balances from scratch
        function recalculateAllBalances() {
            // Reset all balances
            scoutCredits = {};
            troopBalance = 0;
            scouts.forEach(scout => {
                scoutCredits[scout.id] = 0;
            });
            
            // Reprocess all credits (add to balances)
            credits.forEach(credit => {
                troopBalance += credit.amount;
                
                if (credit.scouts && credit.scouts.length > 0) {
                    const perScoutAmount = credit.amount / credit.scouts.length;
                    credit.scouts.forEach(scoutId => {
                        if (!(scoutId in scoutCredits)) scoutCredits[scoutId] = 0;
                        scoutCredits[scoutId] += perScoutAmount;
                    });
                }
            });
            
            // Reprocess all expenses (subtract from balances)
            expenses.forEach(expense => {
                troopBalance -= expense.amount;
                
                if (expense.expenseType === 'grub') {
                    // Special handling for grub expenses
                    const involvedScouts = expense.involvedScouts || [];
                    const submitterId = expense.submitterId;
                    
                    if (involvedScouts.length > 0 && submitterId) {
                        const perScoutShare = expense.amount / involvedScouts.length;
                        
                        // First, credit the full amount to the submitter
                        if (!(submitterId in scoutCredits)) scoutCredits[submitterId] = 0;
                        scoutCredits[submitterId] += expense.amount;
                        
                        // Then, deduct share from each involved scout (including submitter)
                        involvedScouts.forEach(scoutId => {
                            if (!(scoutId in scoutCredits)) scoutCredits[scoutId] = 0;
                            scoutCredits[scoutId] -= perScoutShare;
                        });
                    }
                } else {
                    // Regular expense distribution
                    let affectedScouts = [];
                    if (expense.expenseType === 'troop') {
                        affectedScouts = scouts.map(s => s.id);
                    } else if (expense.expenseType === 'patrol' && expense.entityId) {
                        affectedScouts = scouts.filter(s => s.patrolId === expense.entityId).map(s => s.id);
                    } else if (expense.expenseType === 'scout' && expense.entityId) {
                        affectedScouts = [expense.entityId];
                    }
                    
                    if (affectedScouts.length > 0) {
                        const perScoutShare = expense.amount / affectedScouts.length;
                        affectedScouts.forEach(scoutId => {
                            if (!(scoutId in scoutCredits)) scoutCredits[scoutId] = 0;
                            scoutCredits[scoutId] -= perScoutShare;
                        });
                    }
                }
            });
        }
        
        // Render credits
        function renderCredits() {
            const creditList = document.getElementById('creditList');
            
            // Combine regular credits and grub expense credits
            let allCredits = [];
            
            // Add regular credits
            credits.forEach(credit => {
                allCredits.push({
                    id: credit.id,
                    type: 'credit',
                    date: credit.date,
                    amount: credit.amount,
                    creditType: credit.type,
                    entityName: credit.entityName,
                    scouts: credit.scouts,
                    notes: credit.notes
                });
            });
            
            // Add grub expense credits (when a scout paid for food)
            expenses.filter(exp => exp.expenseType === 'grub').forEach(exp => {
                allCredits.push({
                    id: 'grub-' + exp.id,
                    type: 'grub',
                    date: exp.date,
                    amount: exp.amount,
                    submitterName: exp.submitterName,
                    description: exp.description,
                    involvedScouts: exp.involvedScouts,
                    notes: exp.notes
                });
            });
            
            if (allCredits.length === 0) {
                creditList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí≥</div>
                        <p>No credits recorded yet.</p>
                    </div>
                `;
                return;
            }
            
            // Sort by date (newest first)
            allCredits.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            creditList.innerHTML = allCredits.map(credit => {
                let typeLabel = '';
                let description = '';
                
                if (credit.type === 'credit') {
                    description = 'Payment Received';
                    if (credit.creditType === 'scout') {
                        typeLabel = `<span style="background: #20c997; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600; margin-right: 8px;">Scout: ${credit.entityName}</span>`;
                    } else if (credit.creditType === 'patrol') {
                        const scoutCount = credit.scouts ? credit.scouts.length : 0;
                        typeLabel = `<span style="background: #fd7e14; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600; margin-right: 8px;">Patrol: ${credit.entityName} (${scoutCount} scouts)</span>`;
                    }
                } else if (credit.type === 'grub') {
                    description = credit.description || 'Grub Expense Payment';
                    const scoutCount = credit.involvedScouts ? credit.involvedScouts.length : 0;
                    typeLabel = `<span style="background: #ffc107; color: #333; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 700; margin-right: 8px;">üçî Grub - Paid by: ${credit.submitterName}</span>`;
                    typeLabel += `<span style="background: #6c757d; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600; margin-right: 8px;">${scoutCount} scouts @ $${(credit.amount / scoutCount).toFixed(2)} each</span>`;
                }
                
                return `
                    <div class="expense-item">
                        <div class="expense-info">
                            <div class="expense-description">${description}</div>
                            <div class="expense-meta">
                                ${typeLabel}
                                <span>${formatDate(credit.date)}</span>
                                ${credit.notes ? `<div style="margin-top: 5px; font-size: 0.85em;">${credit.notes}</div>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div class="expense-amount" style="color: #28a745;">+$${credit.amount.toFixed(2)}</div>
                            ${credit.type === 'credit' ? `<button class="expense-delete" onclick="deleteCredit(${credit.id})">Delete</button>` : ''}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update scout balance view
        function updateScoutBalanceView() {
            const display = document.getElementById('scoutBalanceDisplay');
            const selectedScoutId = document.getElementById('scoutBalanceFilter').value;
            
            if (scouts.length === 0) {
                display.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üí∞</div>
                        <p>No scouts added yet. Add scouts to track their balances.</p>
                    </div>
                `;
                return;
            }
            
            let displayScouts = [];
            
            if (selectedScoutId === 'all') {
                displayScouts = scouts;
            } else {
                const scout = scouts.find(s => s.id === selectedScoutId);
                if (scout) displayScouts = [scout];
            }
            
            // Sort by balance (most paid first)
            displayScouts.sort((a, b) => {
                const balanceA = scoutCredits[a.id] || 0;
                const balanceB = scoutCredits[b.id] || 0;
                return balanceB - balanceA;
            });
            
            display.innerHTML = displayScouts.map(scout => {
                const balance = scoutCredits[scout.id] || 0;
                const patrol = scout.patrolId ? patrols.find(p => p.id === scout.patrolId) : null;
                
                let balanceClass = 'zero';
                let statusClass = '';
                let balanceText = '$0.00';
                let statusMessage = '';
                
                if (balance > 0) {
                    balanceClass = 'positive';
                    statusClass = 'positive';
                    balanceText = `+$${balance.toFixed(2)}`;
                    statusMessage = 'Credit (Paid)';
                } else if (balance < 0) {
                    balanceClass = 'negative';
                    statusClass = 'negative';
                    balanceText = `-$${Math.abs(balance).toFixed(2)}`;
                    statusMessage = 'Owes';
                } else {
                    balanceText = '$0.00';
                    statusMessage = 'Settled';
                }
                
                return `
                    <div class="balance-card ${statusClass}">
                        <div class="balance-info">
                            <div class="balance-name">${scout.name}</div>
                            ${patrol ? `<div class="balance-patrol">${patrol.name}</div>` : '<div class="balance-patrol">Unassigned</div>'}
                            <div style="font-size: 0.85em; color: ${balance > 0 ? '#28a745' : balance < 0 ? '#dc3545' : '#6c757d'}; margin-top: 4px;">${statusMessage}</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="balance-amount ${balanceClass}">${balanceText}</div>
                            <button class="button button-secondary" style="padding: 6px 12px; font-size: 0.85em; width: auto;" onclick="viewScoutReport('${scout.id}')">View Report</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Filter by category
        function filterByCategory(category) {
            currentCategoryFilter = category;
            
            // Update button states
            const buttons = event.target.parentElement.querySelectorAll('.filter-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderExpenses();
        }
        
        // Filter by type
        function filterByType(type) {
            currentTypeFilter = type;
            currentEntityFilter = 'all';
            
            // Update button states
            const buttons = event.target.parentElement.querySelectorAll('.filter-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Show entity filters if needed
            const entitySection = document.getElementById('entityFilterSection');
            const entityFilters = document.getElementById('entityFilters');
            const entityLabel = document.getElementById('entityFilterLabel');
            
            if (type === 'patrol' && patrols.length > 0) {
                entityLabel.textContent = 'Filter by Patrol:';
                entityFilters.innerHTML = '<button class="filter-button active" onclick="filterByEntity(\'all\')">All Patrols</button>' +
                    patrols.map(p => `<button class="filter-button" onclick="filterByEntity('${p.id}')">${p.name}</button>`).join('');
                entitySection.style.display = 'block';
            } else if (type === 'scout' && scouts.length > 0) {
                entityLabel.textContent = 'Filter by Scout:';
                entityFilters.innerHTML = '<button class="filter-button active" onclick="filterByEntity(\'all\')">All Scouts</button>' +
                    scouts.map(s => `<button class="filter-button" onclick="filterByEntity('${s.id}')">${s.name}</button>`).join('');
                entitySection.style.display = 'block';
            } else {
                entitySection.style.display = 'none';
            }
            
            renderExpenses();
        }
        
        // Filter by entity (patrol or scout)
        function filterByEntity(entityId) {
            currentEntityFilter = entityId;
            
            // Update button states
            const buttons = event.target.parentElement.querySelectorAll('.filter-button');
            buttons.forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            renderExpenses();
        }
        
        // Render expenses
        function renderExpenses() {
            const expenseList = document.getElementById('expenseList');
            
            let filteredExpenses = expenses;
            
            // Filter by category
            if (currentCategoryFilter !== 'all') {
                filteredExpenses = filteredExpenses.filter(exp => exp.category === currentCategoryFilter);
            }
            
            // Filter by type
            if (currentTypeFilter !== 'all') {
                filteredExpenses = filteredExpenses.filter(exp => exp.expenseType === currentTypeFilter);
            }
            
            // Filter by entity
            if (currentEntityFilter !== 'all') {
                filteredExpenses = filteredExpenses.filter(exp => exp.entityId === currentEntityFilter);
            }
            
            // Sort by date (newest first)
            filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (filteredExpenses.length === 0) {
                expenseList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No expenses match your filters.</p>
                    </div>
                `;
                return;
            }
            
            expenseList.innerHTML = filteredExpenses.map(exp => {
                let typeLabel = '';
                
                if (exp.expenseType === 'grub') {
                    const involvedScouts = exp.involvedScouts || [];
                    const scoutNames = involvedScouts.map(id => {
                        const scout = scouts.find(s => s.id === id);
                        return scout ? scout.name : 'Unknown';
                    }).join(', ');
                    
                    typeLabel = `
                        <span style="background: #ffc107; color: #333; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 700; margin-right: 8px;">
                            üçî Grub Expense
                        </span>
                        <span style="background: #17a2b8; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600; margin-right: 8px;">
                            Paid by: ${exp.submitterName}
                        </span>
                        <div style="margin-top: 8px; font-size: 0.85em; color: #666;">
                            <strong>Involved:</strong> ${scoutNames} (${involvedScouts.length} scouts @ $${(exp.amount / involvedScouts.length).toFixed(2)} each)
                        </div>
                    `;
                } else if (exp.expenseType === 'troop') {
                    typeLabel = '<span style="background: #6f42c1; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600; margin-right: 8px;">Troop</span>';
                } else if (exp.expenseType === 'patrol') {
                    typeLabel = `<span style="background: #fd7e14; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600; margin-right: 8px;">Patrol: ${exp.entityName}</span>`;
                } else if (exp.expenseType === 'scout') {
                    // Find the scout to get their patrol
                    const scout = scouts.find(s => s.id === exp.entityId);
                    const patrol = scout && scout.patrolId ? patrols.find(p => p.id === scout.patrolId) : null;
                    const patrolInfo = patrol ? ` (${patrol.name})` : '';
                    typeLabel = `<span style="background: #20c997; color: white; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600; margin-right: 8px;">Scout: ${exp.entityName}${patrolInfo}</span>`;
                }
                
                return `
                    <div class="expense-item">
                        <div class="expense-info">
                            <div class="expense-description">${exp.description}</div>
                            <div class="expense-meta">
                                ${typeLabel}
                                ${exp.expenseType !== 'grub' ? `<span class="expense-category category-${exp.category}">${getCategoryName(exp.category)}</span>` : ''}
                                <span>${formatDate(exp.date)}</span>
                                ${exp.notes ? `<div style="margin-top: 5px; font-size: 0.85em;">${exp.notes}</div>` : ''}
                            </div>
                        </div>
                        <div style="display: flex; align-items: center;">
                            <div class="expense-amount">$${exp.amount.toFixed(2)}</div>
                            <button class="expense-delete" onclick="deleteExpense(${exp.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update statistics
        function updateStats() {
            const totalSpent = expenses.reduce((sum, exp) => sum + exp.amount, 0);
            const totalCreditsAmount = credits.reduce((sum, cred) => sum + cred.amount, 0);
            
            document.getElementById('totalSpent').textContent = `$${totalSpent.toFixed(2)}`;
            document.getElementById('totalCredits').textContent = `$${totalCreditsAmount.toFixed(2)}`;
            document.getElementById('troopBalance').textContent = `$${troopBalance.toFixed(2)}`;
            document.getElementById('totalCount').textContent = expenses.length;
        }
        
        // Patrol Management
        function openPatrolManager() {
            renderPatrolList();
            document.getElementById('patrolModal').classList.add('active');
        }
        
        function closePatrolManager() {
            document.getElementById('patrolModal').classList.remove('active');
            document.getElementById('newPatrolName').value = '';
        }
        
        function addPatrol() {
            const name = document.getElementById('newPatrolName').value.trim();
            if (!name) {
                alert('Please enter a patrol name');
                return;
            }
            
            patrols.push({
                id: Date.now().toString(),
                name: name
            });
            
            saveData();
            updateDropdowns();
            renderPatrolList();
            document.getElementById('newPatrolName').value = '';
        }
        
        function deletePatrol(id) {
            if (confirm('Are you sure? This will not delete associated expenses.')) {
                patrols = patrols.filter(p => p.id !== id);
                saveData();
                updateDropdowns();
                renderPatrolList();
            }
        }
        
        function renderPatrolList() {
            const list = document.getElementById('patrolList');
            if (patrols.length === 0) {
                list.innerHTML = '<p style="color: #666; text-align: center;">No patrols yet</p>';
                return;
            }
            
            list.innerHTML = patrols.map(p => `
                <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center;">
                    <span><strong>${p.name}</strong></span>
                    <button class="expense-delete" onclick="deletePatrol('${p.id}')">Delete</button>
                </div>
            `).join('');
        }
        
        // Scout Management
        function openScoutManager() {
            updateDropdowns(); // Update patrol dropdown in modal
            renderScoutList();
            document.getElementById('scoutModal').classList.add('active');
        }
        
        function closeScoutManager() {
            document.getElementById('scoutModal').classList.remove('active');
            document.getElementById('newScoutName').value = '';
            document.getElementById('scoutPatrolSelect').value = '';
        }
        
        function addScout() {
            const name = document.getElementById('newScoutName').value.trim();
            if (!name) {
                alert('Please enter a scout name');
                return;
            }
            
            const patrolId = document.getElementById('scoutPatrolSelect').value;
            const newScoutId = Date.now().toString();
            
            scouts.push({
                id: newScoutId,
                name: name,
                patrolId: patrolId || null
            });
            
            // Initialize credit balance
            scoutCredits[newScoutId] = 0;
            
            // Recalculate balances to account for new scout in troop expenses
            recalculateAllBalances();
            
            saveData();
            updateDropdowns();
            updateScoutBalanceDropdown();
            updateGrubScoutFields(); // Update grub fields with new scout
            renderScoutList();
            updateScoutBalanceView();
            updateStats();
            document.getElementById('newScoutName').value = '';
            document.getElementById('scoutPatrolSelect').value = '';
        }
        
        function deleteScout(id) {
            if (confirm('Are you sure? This will recalculate all balances.')) {
                scouts = scouts.filter(s => s.id !== id);
                delete scoutCredits[id];
                
                // Recalculate balances for remaining scouts
                recalculateAllBalances();
                
                saveData();
                updateDropdowns();
                updateScoutBalanceDropdown();
                renderScoutList();
                updateScoutBalanceView();
                updateStats();
            }
        }
        
        function changeScoutPatrol(scoutId, newPatrolId) {
            const scout = scouts.find(s => s.id === scoutId);
            if (scout) {
                scout.patrolId = newPatrolId || null;
                saveData();
                updateDropdowns();
                renderScoutList();
            }
        }
        
        function renderScoutList() {
            const list = document.getElementById('scoutList');
            if (scouts.length === 0) {
                list.innerHTML = '<p style="color: #666; text-align: center;">No scouts yet</p>';
                return;
            }
            
            // Group scouts by patrol
            let html = '';
            
            // Scouts in patrols
            patrols.forEach(patrol => {
                const patrolScouts = scouts.filter(s => s.patrolId === patrol.id);
                if (patrolScouts.length > 0) {
                    html += `<div style="margin-bottom: 20px;">
                        <h4 style="color: #4a7c26; margin-bottom: 10px;">${patrol.name}</h4>`;
                    
                    patrolScouts.forEach(s => {
                        html += `
                            <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <span><strong>${s.name}</strong></span>
                                    <button class="expense-delete" onclick="deleteScout('${s.id}')">Delete</button>
                                </div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <label style="margin: 0; font-size: 0.9em;">Move to:</label>
                                    <select onchange="changeScoutPatrol('${s.id}', this.value)" style="padding: 6px; font-size: 0.9em;">
                                        <option value="">Unassigned</option>
                                        ${patrols.map(p => `<option value="${p.id}" ${p.id === s.patrolId ? 'selected' : ''}>${p.name}</option>`).join('')}
                                    </select>
                                </div>
                            </div>
                        `;
                    });
                    
                    html += `</div>`;
                }
            });
            
            // Unassigned scouts
            const unassignedScouts = scouts.filter(s => !s.patrolId);
            if (unassignedScouts.length > 0) {
                html += `<div style="margin-bottom: 20px;">
                    <h4 style="color: #666; margin-bottom: 10px;">Unassigned Scouts</h4>`;
                
                unassignedScouts.forEach(s => {
                    html += `
                        <div style="background: #f8f9fa; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                <span><strong>${s.name}</strong></span>
                                <button class="expense-delete" onclick="deleteScout('${s.id}')">Delete</button>
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <label style="margin: 0; font-size: 0.9em;">Assign to:</label>
                                <select onchange="changeScoutPatrol('${s.id}', this.value)" style="padding: 6px; font-size: 0.9em;">
                                    <option value="" selected>Unassigned</option>
                                    ${patrols.map(p => `<option value="${p.id}">${p.name}</option>`).join('')}
                                </select>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            }
            
            list.innerHTML = html;
        }
        
        // Budget modal
        function openBudgetModal() {
            // Load current budgets
            Object.keys(budgets).forEach(category => {
                const input = document.getElementById(`budget-${category}`);
                if (input) {
                    input.value = budgets[category];
                }
            });
            
            document.getElementById('budgetModal').classList.add('active');
        }
        
        function closeBudgetModal() {
            document.getElementById('budgetModal').classList.remove('active');
        }
        
        // Save budgets
        document.getElementById('budgetForm').addEventListener('submit', (e) => {
            e.preventDefault();
            
            const categories = ['camping', 'equipment', 'uniforms', 'trips', 'food', 'activities', 'registration'];
            
            categories.forEach(category => {
                const value = parseFloat(document.getElementById(`budget-${category}`).value) || 0;
                if (value > 0) {
                    budgets[category] = value;
                } else {
                    delete budgets[category];
                }
            });
            
            saveData();
            updateBudgetDisplay();
            updateStats();
            closeBudgetModal();
        });
        
        // Update budget display
        function updateBudgetDisplay() {
            const budgetSection = document.getElementById('budgetSection');
            
            if (Object.keys(budgets).length === 0) {
                budgetSection.innerHTML = '<p style="color: #666; text-align: center;">Set category budgets to track spending</p>';
                return;
            }
            
            budgetSection.innerHTML = Object.entries(budgets).map(([category, budget]) => {
                const spent = expenses
                    .filter(exp => exp.category === category)
                    .reduce((sum, exp) => sum + exp.amount, 0);
                
                const percentage = Math.min((spent / budget) * 100, 100);
                const remaining = Math.max(budget - spent, 0);
                
                let statusClass = '';
                if (percentage >= 100) statusClass = 'danger';
                else if (percentage >= 80) statusClass = 'warning';
                
                return `
                    <div class="budget-item">
                        <div class="budget-header">
                            <span><strong>${getCategoryName(category)}</strong></span>
                            <span>$${spent.toFixed(2)} / $${budget.toFixed(2)}</span>
                        </div>
                        <div class="budget-bar">
                            <div class="budget-fill ${statusClass}" style="width: ${percentage}%">
                                ${percentage >= 20 ? percentage.toFixed(0) + '%' : ''}
                            </div>
                        </div>
                        <div style="text-align: right; margin-top: 5px; font-size: 0.85em; color: ${remaining === 0 ? '#dc3545' : '#666'};">
                            ${remaining > 0 ? `$${remaining.toFixed(2)} remaining` : 'Budget exceeded!'}
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Helper functions
        function getCategoryName(category) {
            const names = {
                'grub': 'Grub Expense',
                'camping': 'Camping Equipment',
                'equipment': 'General Equipment',
                'uniforms': 'Uniforms & Patches',
                'trips': 'Trips & Outings',
                'food': 'Food & Supplies',
                'activities': 'Activities & Programs',
                'registration': 'Registration & Fees',
                'other': 'Other'
            };
            return names[category] || category;
        }
        
        function formatDate(dateString) {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        // Export to CSV
        function exportToCSV() {
            if (expenses.length === 0) {
                alert('No expenses to export!');
                return;
            }
            
            const headers = ['Date', 'Description', 'Category', 'Type', 'Patrol/Scout', 'Scout Patrol', 'Amount', 'Paid By', 'Notes'];
            const rows = expenses.map(exp => {
                let scoutPatrol = '';
                if (exp.expenseType === 'scout' && exp.entityId) {
                    const scout = scouts.find(s => s.id === exp.entityId);
                    if (scout && scout.patrolId) {
                        const patrol = patrols.find(p => p.id === scout.patrolId);
                        scoutPatrol = patrol ? patrol.name : '';
                    }
                }
                
                let paidByText = exp.paidBy === 'troop' ? 'Troop' : (exp.paidByScoutName || 'N/A');
                
                return [
                    exp.date,
                    exp.description,
                    getCategoryName(exp.category),
                    exp.expenseType,
                    exp.entityName || 'N/A',
                    scoutPatrol,
                    exp.amount.toFixed(2),
                    paidByText,
                    exp.notes || ''
                ];
            });
            
            // Add scout balances sheet
            let csv = 'EXPENSES\n';
            csv += headers.join(',') + '\n';
            rows.forEach(row => {
                csv += row.map(cell => `"${cell}"`).join(',') + '\n';
            });
            
            csv += '\n\nSCOUT BALANCES\n';
            csv += 'Scout,Patrol,Balance,Status\n';
            scouts.forEach(scout => {
                const balance = scoutCredits[scout.id] || 0;
                const patrol = scout.patrolId ? patrols.find(p => p.id === scout.patrolId) : null;
                const status = balance > 0 ? 'Owed' : balance < 0 ? 'Owes' : 'Even';
                csv += `"${scout.name}","${patrol ? patrol.name : 'Unassigned'}","${balance.toFixed(2)}","${status}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `scout_expenses_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        // Scout Report Functions
        let currentReportScoutId = null;
        
        function viewScoutReport(scoutId) {
            currentReportScoutId = scoutId;
            const scout = scouts.find(s => s.id === scoutId);
            if (!scout) return;
            
            const patrol = scout.patrolId ? patrols.find(p => p.id === scout.patrolId) : null;
            
            // Set title
            document.getElementById('scoutReportTitle').textContent = `${scout.name}'s Transaction Report`;
            
            // Get all transactions for this scout
            const transactions = getScoutTransactions(scoutId);
            
            // Calculate totals
            let totalCredits = 0;
            let totalDebits = 0;
            
            transactions.forEach(t => {
                if (t.amount > 0) totalCredits += t.amount;
                else totalDebits += Math.abs(t.amount);
            });
            
            const balance = scoutCredits[scoutId] || 0;
            
            // Update summary
            document.getElementById('reportTotalCredits').textContent = `$${totalCredits.toFixed(2)}`;
            document.getElementById('reportTotalDebits').textContent = `$${totalDebits.toFixed(2)}`;
            
            const balanceEl = document.getElementById('reportBalance');
            balanceEl.textContent = balance >= 0 ? `+$${balance.toFixed(2)}` : `-$${Math.abs(balance).toFixed(2)}`;
            balanceEl.style.color = balance > 0 ? '#28a745' : balance < 0 ? '#dc3545' : '#6c757d';
            
            // Render transactions
            const transactionList = document.getElementById('scoutTransactionList');
            
            if (transactions.length === 0) {
                transactionList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No transactions found for this scout</p>
                    </div>
                `;
            } else {
                transactionList.innerHTML = transactions.map(t => {
                    const isCredit = t.amount > 0;
                    return `
                        <div class="expense-item">
                            <div class="expense-info">
                                <div class="expense-description">${t.description}</div>
                                <div class="expense-meta">
                                    <span style="background: ${t.color}; color: ${t.textColor}; padding: 4px 10px; border-radius: 12px; font-size: 0.85em; font-weight: 600; margin-right: 8px;">
                                        ${t.type}
                                    </span>
                                    <span>${formatDate(t.date)}</span>
                                    ${t.notes ? `<div style="margin-top: 5px; font-size: 0.85em;">${t.notes}</div>` : ''}
                                </div>
                            </div>
                            <div class="expense-amount" style="color: ${isCredit ? '#28a745' : '#dc3545'};">
                                ${isCredit ? '+' : '-'}$${Math.abs(t.amount).toFixed(2)}
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            document.getElementById('scoutReportModal').classList.add('active');
        }
        
        function closeScoutReport() {
            document.getElementById('scoutReportModal').classList.remove('active');
            currentReportScoutId = null;
        }
        
        function getScoutTransactions(scoutId) {
            const transactions = [];
            
            // Add regular credits
            credits.forEach(credit => {
                if (credit.scouts && credit.scouts.includes(scoutId)) {
                    const perScoutAmount = credit.amount / credit.scouts.length;
                    transactions.push({
                        date: credit.date,
                        description: `Payment Received ${credit.type === 'patrol' ? '(Patrol: ' + credit.entityName + ')' : ''}`,
                        type: 'Credit',
                        amount: perScoutAmount,
                        notes: credit.notes,
                        color: '#28a745',
                        textColor: 'white'
                    });
                }
            });
            
            // Add grub expenses where scout paid
            expenses.filter(exp => exp.expenseType === 'grub' && exp.submitterId === scoutId).forEach(exp => {
                transactions.push({
                    date: exp.date,
                    description: `Grub Payment: ${exp.description}`,
                    type: 'Grub Credit',
                    amount: exp.amount,
                    notes: exp.notes,
                    color: '#ffc107',
                    textColor: '#333'
                });
            });
            
            // Add grub expenses where scout was involved
            expenses.filter(exp => exp.expenseType === 'grub' && exp.involvedScouts && exp.involvedScouts.includes(scoutId)).forEach(exp => {
                const perScoutShare = exp.amount / exp.involvedScouts.length;
                transactions.push({
                    date: exp.date,
                    description: `Grub Share: ${exp.description} (Paid by ${exp.submitterName})`,
                    type: 'Grub Expense',
                    amount: -perScoutShare,
                    notes: exp.notes,
                    color: '#ffc107',
                    textColor: '#333'
                });
            });
            
            // Add regular expenses
            expenses.filter(exp => exp.expenseType !== 'grub').forEach(exp => {
                let affectedScouts = [];
                if (exp.expenseType === 'troop') {
                    affectedScouts = scouts.map(s => s.id);
                } else if (exp.expenseType === 'patrol' && exp.entityId) {
                    affectedScouts = scouts.filter(s => s.patrolId === exp.entityId).map(s => s.id);
                } else if (exp.expenseType === 'scout' && exp.entityId) {
                    affectedScouts = [exp.entityId];
                }
                
                if (affectedScouts.includes(scoutId)) {
                    const perScoutShare = exp.amount / affectedScouts.length;
                    let typeLabel = '';
                    if (exp.expenseType === 'troop') typeLabel = 'Troop Expense';
                    else if (exp.expenseType === 'patrol') typeLabel = 'Patrol Expense';
                    else typeLabel = 'Personal Expense';
                    
                    transactions.push({
                        date: exp.date,
                        description: `${exp.description} (${getCategoryName(exp.category)})`,
                        type: typeLabel,
                        amount: -perScoutShare,
                        notes: exp.notes,
                        color: '#dc3545',
                        textColor: 'white'
                    });
                }
            });
            
            // Sort by date (newest first)
            transactions.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            return transactions;
        }
        
        function exportScoutReportExcel() {
            if (!currentReportScoutId) return;
            
            const scout = scouts.find(s => s.id === currentReportScoutId);
            if (!scout) return;
            
            const transactions = getScoutTransactions(currentReportScoutId);
            const balance = scoutCredits[currentReportScoutId] || 0;
            
            let csv = `${scout.name}'s Transaction Report\n\n`;
            csv += `Current Balance,$${balance.toFixed(2)}\n\n`;
            csv += 'Date,Description,Type,Amount,Notes\n';
            
            transactions.forEach(t => {
                csv += `"${t.date}","${t.description}","${t.type}","${t.amount >= 0 ? '+' : ''}${t.amount.toFixed(2)}","${t.notes || ''}"\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${scout.name.replace(/\s+/g, '_')}_report_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }
        
        function exportScoutReportPDF() {
            if (!currentReportScoutId) return;
            
            const scout = scouts.find(s => s.id === currentReportScoutId);
            if (!scout) return;
            
            alert('PDF export functionality would require a PDF library. For now, please use Excel export or print this page (Ctrl+P / Cmd+P) and save as PDF.');
        }
        
        // Print report
        function printReport() {
            window.print();
        }
        
        // Close modals on background click
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    if (modal.id === 'scoutReportModal') {
                        currentReportScoutId = null;
                    }
                }
            });
        });
    </script>
</body>
</html>